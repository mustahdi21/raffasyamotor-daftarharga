<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daftar Harga OTR</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Swiper CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
</head>
<body class="bg-gray-100">
  <header class="bg-blue-800 text-white text-center py-4 shadow">
    <h1 class="text-2xl font-bold">Raffasya Motor</h1>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Search & Sort -->
    <div class="mb-4 flex justify-between flex-col sm:flex-row gap-2">
      <input
        id="searchInput"
        type="text"
        placeholder="Cari merk/type mobil..."
        class="w-full sm:w-3/4 border border-gray-300 rounded px-4 py-2 shadow-sm focus:ring focus:ring-blue-200"
      />

      <select id="sortPrice" class="w-full sm:w-1/4 border border-gray-300 rounded px-4 py-2 shadow-sm focus:ring focus:ring-blue-200">
        <option value="">Urutkan Harga</option>
        <option value="asc">Harga Terendah</option>
        <option value="desc">Harga Tertinggi</option>
      </select>
    </div>

    <!-- List -->
    <div id="mobilList" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center items-center mt-8 gap-2 flex-wrap"></div>
  </main>

  <!-- Swiper JS -->
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

  <script>
    const apiURL = "https://sheetdb.io/api/v1/rxfo08i7f6pyp";
    const itemsPerPage = 6;

    let allData = [];
    let currentPage = 1;
    let currentSort = "";

    const listContainer = document.getElementById("mobilList");
    const paginationContainer = document.getElementById("pagination");
    const searchInput = document.getElementById("searchInput");
    const sortPrice = document.getElementById("sortPrice");

    function formatRupiah(str) {
      if (!str) return "Rp -";
      let cleaned = str.replace(/Rp\\s?|\\./g, "");
      let number = parseInt(cleaned);
      if (isNaN(number)) return "Rp -";
      return "Rp " + number.toLocaleString("id-ID");
    }

    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      paginationContainer.innerHTML = "";

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = \`px-3 py-1 rounded border \${i === currentPage ? "bg-blue-600 text-white" : "bg-white text-blue-600 hover:bg-blue-100"}\`;
        btn.onclick = () => {
          currentPage = i;
          renderList();
        };
        paginationContainer.appendChild(btn);
      }
    }

    function renderList() {
      const searchText = searchInput.value.toLowerCase();
      const filteredData = allData.filter((item) => {
        const merk = item["MERK/TYPE MOBIL"]?.toLowerCase() || "";
        const nopol = item["NOPOL"]?.toLowerCase() || "";
        return merk.includes(searchText) || nopol.includes(searchText);
      });

      if (currentSort) {
        filteredData.sort((a, b) => {
          const hargaA = parseInt((a['HARGA JUAL (OTR)'] || "0").replace(/Rp\\s?|\\./g, "")) || 0;
          const hargaB = parseInt((b['HARGA JUAL (OTR)'] || "0").replace(/Rp\\s?|\\./g, "")) || 0;
          return currentSort === "asc" ? hargaA - hargaB : hargaB - hargaA;
        });
      }

      const start = (currentPage - 1) * itemsPerPage;
      const pagedData = filteredData.slice(start, start + itemsPerPage);

      listContainer.innerHTML = "";

      pagedData.forEach((item, i) => {
        const card = document.createElement("div");
        card.className = "bg-white shadow rounded overflow-hidden";

        const uniqueId = \`swiper-\${currentPage}-\${i}\`;

        const photos = [];
        for (let j = 1; j <= 10; j++) {
          const key = \`PHOTO \${j}\`;
          if (item[key]) {
            photos.push(\`
              <div class="swiper-slide flex justify-center items-center bg-gray-50">
                <img src="\${item[key]}" alt="Foto \${j}" class="object-cover max-h-48 w-auto mx-auto" />
              </div>
            \`);
          }
        }

        card.innerHTML = \`
          <div class="swiper \${uniqueId}">
            <div class="swiper-wrapper">
              \${photos.join("")}
            </div>
            <div class="swiper-pagination"></div>
          </div>
          <div class="p-4">
            <h2 class="text-lg font-semibold text-gray-800">\${item['MERK/TYPE MOBIL']}</h2>
            <p class="text-sm text-gray-600">Nopol: \${item['NOPOL']}</p>
            <p class="text-sm text-gray-600">Bulan: \${item['BULAN']}</p>
            <p class="text-blue-700 font-bold mt-2">\${formatRupiah(item['HARGA JUAL (OTR)'])} (OTR)</p>
          </div>
        \`;

        listContainer.appendChild(card);

        new Swiper(\`.\${uniqueId}\`, {
          slidesPerView: 1,
          loop: true,
          pagination: {
            el: \`.\${uniqueId} .swiper-pagination\`,
            clickable: true,
          },
        });
      });

      renderPagination(filteredData.length);
    }

    searchInput.addEventListener("input", () => {
      currentPage = 1;
      renderList();
    });

    sortPrice.addEventListener("change", () => {
      currentSort = sortPrice.value;
      currentPage = 1;
      renderList();
    });

    fetch(apiURL)
      .then((res) => res.json())
      .then((data) => {
        allData = data;
        renderList();
      })
      .catch((err) => {
        console.error("Gagal mengambil data:", err);
      });
  </script>
</body>
</html>
